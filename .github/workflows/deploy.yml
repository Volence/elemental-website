name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch: # Allow manual trigger

env:
  REGISTRY: ghcr.io
  # Docker requires lowercase image names
  IMAGE_NAME: volence/elemental-website

jobs:
  build-and-deploy:
    runs-on: ubuntu-24.04-arm  # Native ARM64 runner for faster builds
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to Production Server
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /home/ubuntu/elemental-website
            
            # Log in to GitHub Container Registry (using PAT)
            echo "${{ secrets.GHCR_PAT }}" | docker login ghcr.io -u ${{ github.repository_owner }} --password-stdin
            
            # Pull the latest image first (fail fast if image doesn't exist)
            echo "ðŸ“¦ Pulling latest image..."
            if ! docker pull ghcr.io/volence/elemental-website:latest; then
              echo "âŒ Failed to pull image, aborting deploy"
              exit 1
            fi
            
            # Get postgres password from env file
            POSTGRES_PASS=$(grep POSTGRES_PASSWORD .env.production | cut -d= -f2)
            
            # Start new container with a temporary name first
            echo "ðŸš€ Starting new container..."
            docker run -d \
              --name elemental-website-payload-new \
              --restart unless-stopped \
              -p 127.0.0.1:3001:3000 \
              --env-file .env.production \
              -e DATABASE_URI="postgresql://payload:${POSTGRES_PASS}@elemental-website-postgres-1:5432/payload" \
              -e NODE_ENV=production \
              --network elemental-website_default \
              -v elemental-website_media:/app/public/media \
              -v elemental-website_graphics_assets:/app/public/graphics-assets \
              ghcr.io/volence/elemental-website:latest
            
            # Wait for new container to be healthy
            echo "â³ Waiting for new container to start..."
            sleep 15
            
            # Check if new container is running and healthy
            if curl -s -f http://localhost:3001/api/health > /dev/null 2>&1; then
              echo "âœ… New container is healthy, switching over..."
              
              # Stop old container
              docker stop elemental-website-payload-1 2>/dev/null || true
              docker rm elemental-website-payload-1 2>/dev/null || true
              
              # Stop new container, reconfigure port, rename
              docker stop elemental-website-payload-new
              docker rm elemental-website-payload-new
              
              # Start final container with correct name and port
              docker run -d \
                --name elemental-website-payload-1 \
                --restart unless-stopped \
                -p 127.0.0.1:3000:3000 \
                --env-file .env.production \
                -e DATABASE_URI="postgresql://payload:${POSTGRES_PASS}@elemental-website-postgres-1:5432/payload" \
                -e NODE_ENV=production \
                --network elemental-website_default \
                -v elemental-website_media:/app/public/media \
                -v elemental-website_graphics_assets:/app/public/graphics-assets \
                ghcr.io/volence/elemental-website:latest
              
              echo "âœ… Deployment complete!"
            else
              echo "âŒ New container failed health check, rolling back..."
              docker logs elemental-website-payload-new --tail=30 2>&1 || true
              docker stop elemental-website-payload-new 2>/dev/null || true
              docker rm elemental-website-payload-new 2>/dev/null || true
              echo "Old container preserved, deploy failed"
              exit 1
            fi
            
            # Clean up old images
            docker image prune -f
            docker rmi elemental-website-payload 2>/dev/null || true

      - name: Verify Deployment
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "ðŸ” Verifying deployment..."
            sleep 10
            
            # Check if container is running
            if docker ps | grep -q "elemental-website-payload-1"; then
              echo "âœ… Container is running"
            else
              echo "âŒ Container is not running!"
              docker logs elemental-website-payload-1 --tail=30 2>&1 || true
              exit 1
            fi
            
            # Check if app responds to health check
            for i in {1..6}; do
              if curl -s -f http://localhost:3000/api/health > /dev/null 2>&1; then
                echo "âœ… Health check passed!"
                docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}' | head -5
                exit 0
              fi
              echo "Waiting for health check... ($i/6)"
              sleep 5
            done
            
            echo "âš ï¸ Health check timed out"
            docker logs elemental-website-payload-1 --tail=30 2>&1 || true
            exit 1
